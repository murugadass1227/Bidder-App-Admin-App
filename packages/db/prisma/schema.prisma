// Prisma schema - shared across api and any service needing DB access
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  BIDDER
  SALVAGE_YARD_OPERATOR  // Optional: updates location, release, pickup status
  INSURER_ASSESSOR       // Optional: submits lots, approvals, reserve price
}

enum AuctionStatus {
  DRAFT
  ACTIVE
  ENDED
  CANCELLED
}

enum KycStatus {
  PENDING      // Not submitted
  SUBMITTED    // Uploaded, awaiting admin review
  APPROVED     // Validated; bidding allowed
  REJECTED
}

enum KycDocumentType {
  ID_COPY
  BUSINESS_REGISTRATION
}

enum VerificationCodeType {
  EMAIL_OTP
  EMAIL_LINK
  MOBILE_OTP
}

model User {
  id           String    @id @default(cuid())
  email        String    @unique
  passwordHash String   @map("password_hash")
  name         String?   // Legacy; prefer fullName for bidders
  fullName     String?   @map("full_name")
  mobile       String?   @unique
  role         Role      @default(BIDDER)
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  // Verification (bidder): account active when all three are set
  emailVerifiedAt           DateTime? @map("email_verified_at")
  mobileVerifiedAt          DateTime? @map("mobile_verified_at")
  reservationProofUrl       String?   @map("reservation_proof_url")
  reservationProofVerifiedAt DateTime? @map("reservation_proof_verified_at")

  // Profile (bidder)
  physicalAddress       String? @map("physical_address")
  preferredPaymentMethod String? @map("preferred_payment_method")
  companyDetails        String? @map("company_details") // ID/Company (optional)

  // KYC: mandatory before bidding activation
  kycStatus   KycStatus @default(PENDING) @map("kyc_status")

  // Compliance: accepted timestamps
  termsAcceptedAt        DateTime? @map("terms_accepted_at")
  privacyAcceptedAt      DateTime? @map("privacy_accepted_at")
  auctionRulesAcceptedAt DateTime? @map("auction_rules_accepted_at")
  asIsDisclaimerAcceptedAt DateTime? @map("as_is_disclaimer_accepted_at")

  // Optional 2FA
  twoFactorEnabled Boolean @default(false) @map("two_factor_enabled")
  twoFactorSecret  String? @map("two_factor_secret")

  bids              Bid[]
  auctions          Auction[] @relation("AuctionCreator")
  verificationCodes VerificationCode[]
  kycDocuments      KycDocument[]
  watchlists        Watchlist[]
  invoices          Invoice[]

  @@map("users")
}

model VerificationCode {
  id        String               @id @default(cuid())
  userId    String               @map("user_id")
  type      VerificationCodeType
  code      String
  expiresAt DateTime             @map("expires_at")
  createdAt DateTime             @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, type])
  @@map("verification_codes")
}

model KycDocument {
  id           String          @id @default(cuid())
  userId       String          @map("user_id")
  documentType KycDocumentType @map("document_type")
  fileUrl      String          @map("file_url")
  status       KycStatus       @default(PENDING)
  rejectionReason String?      @map("rejection_reason")
  reviewedAt   DateTime?       @map("reviewed_at")
  createdAt    DateTime        @default(now()) @map("created_at")
  updatedAt    DateTime        @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, documentType])
  @@index([userId])
  @@map("kyc_documents")
}

model Yard {
  id        String   @id @default(cuid())
  name      String
  location  String?
  address   String?  // full address for display
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  auctions Auction[]

  @@map("yards")
}

model Auction {
  id           String        @id @default(cuid())
  title        String
  description  String?
  startPrice   Decimal       @map("start_price") @db.Decimal(12, 2)
  currentPrice Decimal       @map("current_price") @db.Decimal(12, 2)
  status       AuctionStatus @default(DRAFT)
  startsAt     DateTime?     @map("starts_at")
  endsAt       DateTime?     @map("ends_at")
  createdAt    DateTime     @default(now()) @map("created_at")
  updatedAt    DateTime     @updatedAt @map("updated_at")
  creatorId    String        @map("creator_id")

  // Lot / vehicle info
  make         String?  @db.VarChar(100)
  model        String?  @db.VarChar(100)
  year         Int?
  vin          String?  @db.VarChar(50)  // masked until permitted
  engineNumber String?  @map("engine_number") @db.VarChar(50)
  mileage      Int?     // if known
  accidentSummary String? @map("accident_summary") @db.Text
  damageNotes  String?  @map("damage_notes") @db.Text
  damageType   String?  @map("damage_type") @db.VarChar(100)

  // Yard / location
  yardId     String?   @map("yard_id")
  yard       Yard?     @relation(fields: [yardId], references: [id], onDelete: SetNull)
  yardName   String?   @map("yard_name")   // denormalized for filter/search
  yardLocation String?  @map("yard_location")
  inspectionTimes String? @map("inspection_times") @db.Text
  viewingInstructions String? @map("viewing_instructions") @db.Text

  // Media (JSON array of URLs, or single video URL)
  photoUrls String?   @map("photo_urls") @db.Text   // JSON array
  videoUrl  String?   @map("video_url") @db.VarChar(500)

  // Auction rules
  reservePrice   Decimal? @map("reserve_price") @db.Decimal(12, 2)
  bidIncrement   Decimal? @map("bid_increment") @db.Decimal(12, 2)
  buyerFees      Decimal? @map("buyer_fees") @db.Decimal(12, 2)
  vatTaxes       Decimal? @map("vat_taxes") @db.Decimal(12, 2)
  extendMinutes  Int?     @map("extend_minutes")   // anti-sniping: extend end if bid in last X min

  creator   User    @relation("AuctionCreator", fields: [creatorId], references: [id], onDelete: Cascade)
  bids      Bid[]
  watchlists Watchlist[]
  invoices  Invoice[]

  @@index([status])
  @@index([make])
  @@index([year])
  @@index([yardId])
  @@index([damageType])
  @@map("auctions")
}

model Watchlist {
  id        String    @id @default(cuid())
  userId    String    @map("user_id")
  auctionId String    @map("auction_id")
  reminderAt DateTime? @map("reminder_at")
  createdAt DateTime  @default(now()) @map("created_at")

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  auction Auction @relation(fields: [auctionId], references: [id], onDelete: Cascade)

  @@unique([userId, auctionId])
  @@index([userId])
  @@map("watchlists")
}

enum InvoiceStatus {
  PENDING
  PAID
  CANCELLED
}

model Invoice {
  id             String        @id @default(cuid())
  userId         String        @map("user_id")
  auctionId      String        @map("auction_id")
  amount         Decimal       @db.Decimal(12, 2)
  fees           Decimal       @db.Decimal(12, 2)
  taxes          Decimal       @db.Decimal(12, 2)
  status         InvoiceStatus @default(PENDING)
  invoiceNumber  String        @map("invoice_number") @unique
  paidAt         DateTime?     @map("paid_at")
  releaseNoteUrl String?       @map("release_note_url")
  createdAt      DateTime      @default(now()) @map("created_at")
  updatedAt      DateTime      @updatedAt @map("updated_at")

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  auction Auction @relation(fields: [auctionId], references: [id], onDelete: Cascade)

  @@unique([userId, auctionId])
  @@index([userId])
  @@map("invoices")
}

model RefreshTokenBlacklist {
  id        String   @id @default(cuid())
  jti       String   @unique
  expiresAt DateTime @map("expires_at")

  @@map("refresh_token_blacklist")
}

model Bid {
  id        String   @id @default(cuid())
  amount    Decimal  @db.Decimal(12, 2)
  maxBid    Decimal? @map("max_bid") @db.Decimal(12, 2)  // optional auto-bid max
  createdAt DateTime @default(now()) @map("created_at")
  userId    String   @map("user_id")
  auctionId String   @map("auction_id")

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  auction Auction @relation(fields: [auctionId], references: [id], onDelete: Cascade)

  @@unique([auctionId, userId])
  @@index([auctionId])
  @@index([userId])
  @@map("bids")
}
