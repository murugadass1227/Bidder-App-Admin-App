// Prisma schema - shared across api and any service needing DB access
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  BIDDER
}

enum AuctionStatus {
  DRAFT
  ACTIVE
  ENDED
  CANCELLED
}

model User {
  id           String    @id @default(cuid())
  email        String    @unique
  passwordHash String   @map("password_hash")
  name         String?
  role         Role      @default(BIDDER)
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  bids    Bid[]
  auctions Auction[] @relation("AuctionCreator")

  @@map("users")
}

model Auction {
  id          String        @id @default(cuid())
  title       String
  description String?
  startPrice   Decimal   @map("start_price") @db.Decimal(12, 2)
  currentPrice Decimal  @map("current_price") @db.Decimal(12, 2)
  status      AuctionStatus @default(DRAFT)
  startsAt    DateTime?   @map("starts_at")
  endsAt      DateTime?   @map("ends_at")
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")
  creatorId   String      @map("creator_id")

  creator User   @relation("AuctionCreator", fields: [creatorId], references: [id], onDelete: Cascade)
  bids    Bid[]

  @@map("auctions")
}

model RefreshTokenBlacklist {
  id        String   @id @default(cuid())
  jti       String   @unique
  expiresAt DateTime @map("expires_at")

  @@map("refresh_token_blacklist")
}

model Bid {
  id        String   @id @default(cuid())
  amount    Decimal  @db.Decimal(12, 2)
  createdAt DateTime @default(now()) @map("created_at")
  userId    String   @map("user_id")
  auctionId String   @map("auction_id")

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  auction Auction @relation(fields: [auctionId], references: [id], onDelete: Cascade)

  @@unique([auctionId, userId])
  @@index([auctionId])
  @@index([userId])
  @@map("bids")
}
